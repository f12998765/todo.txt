<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>todo.txt</title>

<!-- PWA Meta Tags -->
<meta name="description" content="åŠŸèƒ½å¼ºå¤§çš„todo.txtä»»åŠ¡ç®¡ç†åº”ç”¨">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="todo.txt">
<link rel="apple-touch-icon" href="./todo.jpg">
<meta name="mobile-web-app-capable" content="yes">

<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./todo.jpg" type="image/jpeg">
<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --accent:#3b82f6;
  --good:#10b981;
  --warn:#f59e0b;
  --bad:#ef4444;
  --shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
  --radius: 12px;
  --sf: -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  
  /* å¯è‡ªå®šä¹‰çš„å­—æ®µæ ·å¼å˜é‡ */
  --project-color: #2563eb;
  --project-bg: #eff6ff;
  --project-border: #bfdbfe;
  --context-color: #7c3aed;
  --context-bg: #f3e8ff;
  --context-border: #c4b5fd;
  --priority-color: #dc2626;
  --priority-bg: #fef2f2;
  --priority-border: #fecaca;
  --date-color: #059669;
  --date-bg: #ecfdf5;
  --date-border: #a7f3d0;
  --url-color: #ec4899;
  --url-bg: #fdf2f8;
  --url-border: #f9a8d4;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 var(--sf);}

header{
  background:rgba(255,255,255,.85); backdrop-filter: blur(12px);
  border-bottom:1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,.02);
}
.container{max-width: 1080px; margin:0 auto; padding:10px 16px}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
h1{font-size:18px; margin:0; font-weight:700}
.muted{color:var(--muted)}
.grow{flex:1}

.input, .select, .btn{
  height:36px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
  padding:0 12px; outline:none;
}
.input{min-width:220px; flex:1}
.btn_full {
   width: 100%;
}
.btn{cursor:pointer; transition: all 0.2s ease-out;}
.btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
.btn.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
}
.btn.secondary{background:#f1f5f9; border-color:#cbd5e1; color:#475569;}
.btn.secondary:hover{
  background:#e2e8f0; 
  border-color:#94a3b8;
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.btn.ghost{background:transparent}
.btn.destructive{background:#fef2f2; border-color:#fecaca; color:#dc2626}
.btn.destructive:hover{background:#fee2e2; border-color:#fca5a5; transform: translateY(-1px);}

/* ç¡®ä¿æœç´¢æ¡†åŠæ¸…ç©ºæŒ‰é’®çš„å®¹å™¨è¡Œä¸º */
.search-wrapper {
  position: relative; /* ä¿æŒåŸæœ‰çš„ç›¸å¯¹å®šä½ */
  flex-grow: 1; /* å…è®¸å…¶åœ¨æœ‰ç©ºé—´æ—¶å¢é•¿ */
  flex-shrink: 0; /* é˜²æ­¢å…¶è¿‡åº¦ç¼©å°ï¼Œä¿æŒæœ€å°å®½åº¦ */
  min-width: 220px; /* é»˜è®¤æœ€å°å®½åº¦ (ä¸ input ç›¸åŒæˆ–ç¨å¤§) */
  max-width: 100%; /* é¿å…è¶…å‡ºçˆ¶å®¹å™¨ */
}

/* ä¼˜åŒ–æœç´¢è¾“å…¥æ¡†çš„æ ·å¼ï¼Œè®©å…¶å®Œå…¨å¡«å……å…¶çˆ¶å®¹å™¨çš„å¯ç”¨ç©ºé—´ */
.search-wrapper #search {
  width: 100%; /* è®©è¾“å…¥æ¡†å¡«å……çˆ¶å®¹å™¨ */
  min-width: unset; /* ç§»é™¤ input è‡ªèº«çš„ min-width é™åˆ¶ï¼Œç”± search-wrapper æ§åˆ¶ */
  flex: none; /* ç§»é™¤ input è‡ªèº«çš„ flex å±æ€§ï¼Œç”± search-wrapper æ§åˆ¶ */
  padding-right: 36px; /* ç•™å‡ºç©ºé—´ç»™ clearSearch æŒ‰é’® */
}

/* ç¡®ä¿æ¸…ç©ºæŒ‰é’®å§‹ç»ˆå¯è§ä¸”ä¸å½±å“å¸ƒå±€ */
#clearSearch {
  position: absolute;
  right: 2px;
  top: 2px;
  height: 32px;
  padding: 0 8px;
  background: transparent;
  border: none;
  color: var(--muted);
  display: none; /* é»˜è®¤éšè—ï¼ŒJS æ§åˆ¶æ˜¾ç¤º */
}

/* é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„è°ƒæ•´ */
@media (max-width: 640px){
  .search-wrapper {
    min-width: 100%; /* åœ¨å°å±å¹•ä¸Šè®©æœç´¢æ¡†å®¹å™¨å æ®æ•´è¡Œ */
    /* max-width å¯ä»¥ä¿æŒï¼Œæˆ–è€…æ ¹æ®éœ€è¦è°ƒæ•´ */
  }
  /* main-controls ä¸­çš„ input min-width å¯ä»¥ç§»é™¤æˆ–è°ƒæ•´ï¼Œå› ä¸ºå®ƒç°åœ¨è¢« .search-wrapper æ§åˆ¶ */
  .main-controls .input { /* ç§»é™¤æ­¤è§„åˆ™å¯¹ search input çš„å½±å“ */
    min-width: unset;
    max-width: unset;
  }
  /* ä¹Ÿå¯ä»¥ä¸“é—¨ä¸ºå°å±å¹•ä¸‹çš„æœç´¢è¾“å…¥æ¡†è®¾ç½®æ›´åˆé€‚çš„ min-width */
  .search-wrapper #search {
    min-width: 140px; /* æˆ–è€…æ›´å°ï¼Œä»¥é€‚åº”ç§»åŠ¨è®¾å¤‡ */
  }
}

/* filter group styles */
.filter-group{display:flex; gap:8px; align-items:center;}
.filter-select{
  min-width:120px; background:#f8fafc; border-color:#cbd5e1; 
  transition: all 0.2s ease; font-size:13px;
}
.filter-select:hover{background:#f1f5f9; border-color:#94a3b8;}
.filter-select:focus{background:#fff; border-color:var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1);}
.filter-clear{
  padding:0 10px; font-size:13px; color:var(--muted); 
  border-color:#e2e8f0; transition: all 0.2s ease;
}
.filter-clear:hover{
  background:#fef2f2; border-color:#fecaca; color:#dc2626;
  transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

main{max-width:1080px; margin:12px auto 80px; padding:0 16px; display:flex; flex-direction:column; gap:16px}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow: var(--shadow)}
.main-header{display:flex; align-items:center; padding:0 4px; margin-bottom:12px; justify-content: space-between;} /* Moved inline style */
.main-controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.list{display:flex; flex-direction:column; gap:10px; padding-right:6px; padding-bottom:60px;}
.main-list{padding-right:8px;}

/* tasks */
.task{
  position: relative;
  display:grid; grid-template-columns:24px 1fr auto; gap:10px; align-items:start;
  padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff;
  animation: fadeIn 0.3s ease-out;
  margin-bottom: 4px; /* å¢åŠ ä»»åŠ¡é—´è· */
}
.task.done{opacity:.5; filter: grayscale(0.3);}
.title{font-weight:600; cursor:text; word-break:break-word; line-height:1.4;}
.meta{font-size:12px; color:var(--muted); display:flex; gap:4px; flex-wrap:wrap; margin-top:6px; line-height:1.3;}
.actions{
  position: absolute; top: 10px; right: 10px; /* ç»å¯¹å®šä½ï¼Œé˜²æ­¢æŒ¤å‹å¸ƒå±€ */
  display:none; gap:6px; align-items:flex-start; flex-shrink:0;
  background: var(--card); /* æ·»åŠ èƒŒæ™¯è‰²é˜²æ­¢æ–‡å­—é‡å  */
  padding: 2px 4px;
  border-radius: 6px;
}
.task:hover .actions{display:flex;}
.actions .btn{white-space:nowrap; font-size:12px; padding:4px 8px; height:auto; min-height:28px;}
.badge{
  display:inline-flex; align-items:center; gap:4px; max-width:100%;
  border:1px solid var(--border); border-radius:999px; padding:2px 8px; background:#fafafa; color:#555; font-size:12px;
}
.badge.pri{color:var(--priority-color); background:var(--priority-bg); border-color:var(--priority-border);}
.badge.due{color:var(--date-color); background:var(--date-bg); border-color:var(--date-border);}
.badge.over{color:#ef4444; background:#fef2f2; border-color:#fecaca;}
.badge.start{color:var(--date-color); background:var(--date-bg); border-color:var(--date-border);}
.badge.proj{color:var(--project-color); background:var(--project-bg); border-color:var(--project-border);}
.badge.ctx{color:var(--context-color); background:var(--context-bg); border-color:var(--context-border);}
.badge.rec{color:#0891b2; background:#ecfeff; border-color:#a5f3fc;}
.badge.time{color:#16a34a; background:#f0fdf4; border-color:#bbf7d0;}
.badge.time.expired{color:#dc2626; background:#fef2f2; border-color:#fecaca; font-weight:600;}
.badge.link{cursor:pointer; transition: all 0.2s ease; opacity: 0.8;}
.badge.link:hover{opacity: 1; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
.badge.url{
  color:var(--url-color); background:var(--url-bg); border-color:var(--url-border);
  cursor:pointer; transition: all 0.2s ease;
}
.badge.url:hover{
  opacity: 0.8; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(236,72,153,0.2);
}
.settings-btn{
  width:32px; height:32px; padding:0; 
  display:flex; align-items:center; justify-content:center; 
  font-size:14px; border-radius:6px;
  background:rgba(255,255,255,0.1); 
  border:1px solid rgba(255,255,255,0.2);
  transition: all 0.2s ease;
}
.settings-btn:hover{
  background:rgba(255,255,255,0.2); 
  border-color:rgba(255,255,255,0.3);
  transform: scale(1.05);
}
.settings-btn:active{
  transform: scale(0.95);
}
.rawbox{
  grid-column: 1 / -1;
  display:none; gap:8px; flex-wrap:wrap; margin-top:8px;
}
.rawtext{
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:12px; background:#f6f8fa; border:1px solid var(--border);
  padding:6px 8px; border-radius:8px; color:#333; max-width:100%; overflow:auto;
}

/* drawer (settings) */
.drawer{
  position: fixed; right:16px; top:16px; width:360px; max-width:92vw;
  background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow); padding:12px; display:none; z-index:50;
}
.drawer.open{display:block}
.section{margin:8px 0}
.section-title{font-weight:600; font-size:13px; color:#4b5563; margin:6px 0}
.grid{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
.row{display:flex; gap:8px; align-items:center; margin:6px 0}
/* Moved inline styles */
.control-group label {
  font-size:13px;
  color:#666;
}
#sort.select {
  flex: 1;
}

/* åˆ†ç»„æ ·å¼ */
.group-container{margin-bottom:20px;}
.group-header{
  background:rgba(59,130,246,0.1); 
  border:1px solid rgba(59,130,246,0.2);
  padding:8px 12px; margin-bottom:8px; 
  border-radius:8px; font-weight:600; 
  color:#1e40af; font-size:13px;
  display:flex; align-items:center; justify-content:space-between;
}
.group-count{
  background:rgba(59,130,246,0.2); 
  color:#1e40af; padding:2px 6px; 
  border-radius:10px; font-size:11px; font-weight:normal;
}
.group-tasks{margin-left:0;}

/* å­—æ®µæ ·å¼é…ç½®æ¨¡æ€æ¡† */
.field-style-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  z-index: 1000;
  width: 500px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.field-style-modal.open {
  opacity: 1;
  visibility: visible;
}

.field-style-modal-header {
  padding: 20px 20px 0;
  border-bottom: 1px solid #e2e8f0;
  margin-bottom: 20px;
  cursor: move;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.field-style-modal-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.field-style-modal-body {
  padding: 0 20px 20px;
}

.field-group {
  margin-bottom: 25px;
  padding: 15px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
}

.field-group-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 15px;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

.field-preview {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 500;
  border: 1px solid;
}

.style-controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.style-control {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.style-control label {
  font-size: 12px;
  color: #64748b;
  font-weight: 500;
}

.color-input-wrapper {
  display: flex;
  gap: 8px;
  align-items: center;
}

.color-picker {
  width: 35px;
  height: 30px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  padding: 0;
}

.color-text-input {
  flex: 1;
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 12px;
  font-family: monospace;
}

.field-style-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

.field-style-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
}

.field-style-btn-primary {
  background: #3b82f6;
  color: white;
}

.field-style-btn-primary:hover {
  background: #2563eb;
}

.field-style-btn-secondary {
  background: #f1f5f9;
  color: #64748b;
}

.field-style-btn-secondary:hover {
  background: #e2e8f0;
}

/* confirm bar & toast */
.confirm-bar{display:flex; gap:8px; align-items:center; background:#fffbeb; border:1px solid #fed7aa; color:#92400e; padding:8px 10px; border-radius:10px; margin-top:8px}
.toast{
  position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
  background:rgba(30,30,30,.9); color:#fff; padding:10px 14px; border-radius:999px; box-shadow: var(--shadow);
  opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:60;
}
.toast.show{opacity:1}

/* floating editor window (draggable, resizable) */
.modal{
  position: fixed; left:50%; top:50%; transform: translate(-50%, -50%);
  width: min(900px, 92vw); height: min(70vh, 600px);
  background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow);
  display:none; z-index:80; resize: both; overflow: hidden;
}
.modal.open{display:block}
.modal-header{
  display:flex; align-items:center; gap:8px; padding:10px 12px; cursor:move;
  border-bottom:1px solid var(--border); background:#fafafa;
}
.modal-title{font-weight:600}
.modal-body{padding:10px; height: calc(100% - 48px); display:flex; flex-direction:column}
.modal-actions{display:flex; gap:8px; justify-content:flex-end; padding-top:8px}
textarea{width:100%; flex:1; border:1px solid var(--border); border-radius:8px; padding:10px; resize: none; background:#fff; color:var(--text)}

/* search hints */
.search-hints{
  position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 10;
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 8px; font-size: 12px; color: var(--muted);
  display: none;
}
.search-hints.show{display: block;}
.hint-item{padding: 4px 0; border-bottom: 1px solid var(--border);}
.hint-item:last-child{border-bottom: none;}
.hint-syntax{font-family: monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; margin-right: 8px;}

/* åŠ¨ç”» & ç©ºçŠ¶æ€ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  margin: 20px 0;
  animation: fadeIn 0.5s ease-out;
}
.empty-state h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  color: var(--text);
}

/* New style for appTitle image */
#appTitle img {
  height: 48px;
  width: 48px;
  border-radius: 8px;
  object-fit: cover;
}

@media (max-width: 640px){
  .search-hints{font-size: 11px; padding: 6px;}
  .hint-item{padding: 3px 0;}
  .hint-syntax{padding: 1px 3px; margin-right: 6px; font-size: 10px;}
}

/* mobile tweaks */
@media (max-width: 640px){
  .input{min-width:140px}
  .task{
    grid-template-columns:20px 1fr; gap:8px; padding:8px;
    grid-template-areas: 
      "checkbox content"
      "actions actions";
  }
  .task > input[type="checkbox"]{grid-area:checkbox; margin-top:2px;}
  .task > div:nth-child(2){grid-area:content;}
  .task .actions{
    grid-area:actions; justify-self:end; margin-top:8px;
    gap:4px; flex-direction:row;
    position: static; /* åœ¨ç§»åŠ¨ç«¯æ¢å¤é™æ€å®šä½ */
  }
  .actions .btn{
    height:28px; padding:4px 8px; font-size:11px; 
    border-radius:6px; min-width:auto;
  }
  .title{font-size:14px; line-height:1.3;}
  .meta{gap:3px; margin-top:4px;}
  .badge{
    font-size:10px; padding:1px 6px; 
    border-radius:12px; line-height:1.2;
  }
  .drawer{right:8px; top:8px; width:92vw}
  .modal{width:96vw; height:70vh}
  .filter-group{flex-wrap:wrap; gap:6px;}
  .filter-select{min-width:100px; font-size:12px;}
  .filter-clear{padding:0 8px; font-size:12px;}
  .row{flex-wrap:wrap; gap:6px;}
  .container{padding:8px 12px;}
  h1{font-size:16px;}
  .main-header{flex-direction:column; align-items:stretch; gap:10px; margin-bottom:12px;}
  .main-controls{justify-content:center; gap:8px;}
  .main-controls .input{min-width:140px; flex:1; max-width:220px;}
  .main-controls .select{min-width:90px;}
  .main-list{max-height:70vh;}
  .field-style-modal{width:95vw;}
  .style-controls{grid-template-columns:1fr;}
}
</style>
<style>.control-group { display: flex; align-items: center; gap: 8px; }</style>
</head>
<body>

<header>
  <div class="container">
    <div class="row">
      <div id="appTitle" title="ç‚¹å‡»åˆ·æ–°">
        <img src="./todo.jpg" alt="todo.txt icon">
      </div>
      <div class="grow"></div>
      <button id="settingsBtn" class="btn settings-btn" title="è®¾ç½®">âš™ï¸</button>
    </div>
  </div>
</header>

<main>
  <div class="main-header">
    <div class="main-controls">
      <div class="search-wrapper">
        <input id="search" class="input search-input" placeholder="ğŸ” æœç´¢ä»»åŠ¡ã€é¡¹ç›®ã€ä¸Šä¸‹æ–‡..." />
        <button id="clearSearch" class="btn">âŒ</button>
        <div id="searchHints" class="search-hints">
          <div class="hint-item"><span class="hint-syntax">+é¡¹ç›®å</span>æœç´¢ç‰¹å®šé¡¹ç›®</div>
          <div class="hint-item"><span class="hint-syntax">@ä¸Šä¸‹æ–‡</span>æœç´¢ç‰¹å®šä¸Šä¸‹æ–‡</div>
          <div class="hint-item"><span class="hint-syntax">pri:A</span>æœç´¢ä¼˜å…ˆçº§</div>
          <div class="hint-item"><span class="hint-syntax">due:2025</span>æœç´¢æˆªæ­¢æ—¥æœŸ</div>
          <div class="hint-item"><span class="hint-syntax">å…³é”®è¯</span>æœç´¢ä»»åŠ¡å†…å®¹</div>
        </div>
      </div>
    </div>
    <div class="main-controls">
        <button id="quickCleanupBtn" class="btn settings-btn" title="æ¸…ç†å·²è¿‡æœŸä»»åŠ¡"></button>
        <div class="control-group">
          <label>çŠ¶æ€:</label>
          <select id="status" class="select">
            <option value="all">æ‰€æœ‰ä»»åŠ¡</option>
            <option value="open">æœªå®Œæˆ</option>
            <option value="actionable" selected>è¡ŒåŠ¨ä¸­</option>
            <option value="ongoing">æ­£åœ¨è¿›è¡Œ</option>
            <option value="pending">æœªå¼€å§‹</option>
            <option value="expired">å·²è¿‡æœŸ</option>
            <option value="done">å·²å®Œæˆ</option>
          </select>
        </div>
        <div class="control-group">
          <label>åˆ†ç»„:</label>
          <select id="groupBy" class="select">
            <option value="none">ä¸åˆ†ç»„</option>
            <option value="project" selected>æŒ‰é¡¹ç›®åˆ†ç»„</option>
            <option value="context">æŒ‰ä¸Šä¸‹æ–‡åˆ†ç»„</option>
            <option value="priority">æŒ‰ä¼˜å…ˆçº§åˆ†ç»„</option>
            <option value="status">æŒ‰çŠ¶æ€åˆ†ç»„</option>
          </select>
        </div>
    </div>
  </div>
  <div id="list" class="list main-list"></div>

  <div class="drawer" id="drawer">
    <div class="section">
      <div class="row">
        <strong>è®¾ç½®</strong>
        <div class="grow"></div>
        <button id="closeDrawer" class="btn">å…³é—­</button>
      </div>
    </div>
    <div class="section">
      <div class="section-title">è§†å›¾ä¸æ’åº</div>
      <div class="row">
        <label>æ’åºæ–¹å¼:</label>
        <select id="sort" class="select">
          <option value="priority,due,start,text">ä¼˜å…ˆçº§â†’æˆªæ­¢â†’å¼€å§‹â†’æ–‡æœ¬</option>
          <option value="due,start,priority,text">æˆªæ­¢â†’å¼€å§‹â†’ä¼˜å…ˆçº§â†’æ–‡æœ¬</option>
          <option value="countdown,priority,text">å€’è®¡æ—¶â†’ä¼˜å…ˆçº§â†’æ–‡æœ¬</option>
          <option value="priority,countdown,text">ä¼˜å…ˆçº§â†’å€’è®¡æ—¶â†’æ–‡æœ¬</option>
          <option value="start,due,priority,text">å¼€å§‹â†’æˆªæ­¢â†’ä¼˜å…ˆçº§â†’æ–‡æœ¬</option>
          <option value="created,priority,text">åˆ›å»ºæ—¶é—´â†’ä¼˜å…ˆçº§â†’æ–‡æœ¬</option>
          <option value="text">æŒ‰æ–‡æœ¬æ’åº</option>
        </select>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ä»»åŠ¡ç®¡ç†</div>
      <div class="grid">
        <button id="clearDoneBtn" class="btn secondary">æ¸…ç†å·²å®Œæˆ</button>
        <button id="clearExpiredBtn" class="btn secondary">æ¸…ç†å·²è¿‡æœŸ</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">æ–‡æœ¬ç¼–è¾‘</div>
      <div class="row">
        <button id="openEditorBtn" class="btn primary btn_full">æ‰“å¼€ todo.txt ç¼–è¾‘å™¨</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">å­—æ®µæ ·å¼</div>
      <div class="row">
        <button id="openFieldStyleBtn" class="btn primary btn_full">è‡ªå®šä¹‰å­—æ®µæ ·å¼</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">GitHub Gist åŒæ­¥</div>
      <p class="muted" style="font-size:12px; margin: 4px 0;">å°†æ‚¨çš„ä»»åŠ¡åˆ—è¡¨ä¸ä¸€ä¸ªç§æœ‰çš„ GitHub Gist åŒæ­¥ã€‚æ‚¨çš„å‡­æ®å°†ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</p>
      <p class="muted" style="font-size:12px; color:#ef4444; margin: 4px 0;">**è­¦å‘Š: å°† PAT å­˜å‚¨åœ¨æµè§ˆå™¨ `localStorage` ä¸­å­˜åœ¨è·¨ç«™è„šæœ¬ (XSS) æ”»å‡»é£é™©ã€‚è¯·ç¡®ä¿æ‚¨çš„æµè§ˆå™¨å’Œä½¿ç”¨çš„æ‰©å±•ç¨‹åºæ˜¯å®‰å…¨çš„ã€‚**</p>
      <div class="row">
        <input id="gistId" type="text" class="input" placeholder="Gist ID" autocomplete="username">
      </div>
      <div class="row">
        <input id="githubPat" type="password" class="input" placeholder="GitHub Personal Access Token (PAT)" autocomplete="current-password">
      </div>
      <div class="row">
        <button id="saveGistSettings" class="btn secondary btn_full">ä¿å­˜å‡­æ®</button>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 8px;">
        <button id="pullFromGistBtn" class="btn secondary">æ‹‰å– (Pull)</button>
        <button id="pushToGistBtn" class="btn primary">æ¨é€ (Push)</button>
      </div>
      <div id="syncStatus" class="muted" style="font-size:11px; text-align:right; margin-top:4px;"></div>
    </div>

    <div class="section">
      <div class="section-title">æ•°æ®ç®¡ç†</div>
      <div class="grid">
        <button id="exportBtn" class="btn">å¯¼å‡º .txt</button>
        <label class="btn" style="display:flex;align-items:center;justify-content:center">
          å¯¼å…¥ .txt
          <input id="importInput" type="file" accept=".txt" style="display:none">
        </label>
      </div>
    </div>

    <div class="section">
      <div class="section-title">å±é™©æ“ä½œ</div>
      <div class="row">
        <button id="resetBtn" class="btn destructive btn_full">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
      </div>
      <div id="settingsConfirmHost"></div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<div class="modal" id="editorModal">
  <div class="modal-header" id="modalDragHandle">
    <span class="modal-title">todo.txt æ–‡æœ¬</span>
    <div class="grow"></div>
    <button id="closeEditor" class="btn">å…³é—­</button>
  </div>
  <div class="modal-body">
    <textarea id="raw"></textarea>
    <div class="modal-actions">
      <button id="applyTxt" class="btn primary">åº”ç”¨æ–‡æœ¬</button>
    </div>
  </div>
</div>

<!-- å­—æ®µæ ·å¼é…ç½®æµ®åŠ¨çª—å£ -->
<div class="field-style-modal" id="fieldStyleModal">
  <div class="field-style-modal-header" id="fieldStyleModalDragHandle">
    <span class="field-style-modal-title">è‡ªå®šä¹‰å­—æ®µæ ·å¼</span>
    <button id="closeFieldStyle" class="btn">å…³é—­</button>
  </div>
  <div class="field-style-modal-body">
    
    <!-- é¡¹ç›®å­—æ®µæ ·å¼ -->
    <div class="field-group">
      <div class="field-group-title">
        é¡¹ç›®æ ‡ç­¾ (+project)
        <span class="field-preview" id="projectPreview">+ç¤ºä¾‹é¡¹ç›®</span>
      </div>
      <div class="style-controls">
        <div class="style-control">
          <label>æ–‡å­—é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="projectColorPicker" class="color-picker" value="#2563eb">
            <input type="text" id="projectColorInput" class="color-text-input" placeholder="#2563eb">
          </div>
        </div>
        <div class="style-control">
          <label>èƒŒæ™¯é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="projectBgPicker" class="color-picker" value="#eff6ff">
            <input type="text" id="projectBgInput" class="color-text-input" placeholder="#eff6ff">
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸Šä¸‹æ–‡å­—æ®µæ ·å¼ -->
    <div class="field-group">
      <div class="field-group-title">
        ä¸Šä¸‹æ–‡æ ‡ç­¾ (@context)
        <span class="field-preview" id="contextPreview">@ç¤ºä¾‹ä¸Šä¸‹æ–‡</span>
      </div>
      <div class="style-controls">
        <div class="style-control">
          <label>æ–‡å­—é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="contextColorPicker" class="color-picker" value="#7c3aed">
            <input type="text" id="contextColorInput" class="color-text-input" placeholder="#7c3aed">
          </div>
        </div>
        <div class="style-control">
          <label>èƒŒæ™¯é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="contextBgPicker" class="color-picker" value="#f3e8ff">
            <input type="text" id="contextBgInput" class="color-text-input" placeholder="#f3e8ff">
          </div>
        </div>
      </div>
    </div>

    <!-- ä¼˜å…ˆçº§å­—æ®µæ ·å¼ -->
    <div class="field-group">
      <div class="field-group-title">
        ä¼˜å…ˆçº§æ ‡ç­¾ ((A), (B), (C))
        <span class="field-preview" id="priorityPreview">P:A</span>
      </div>
      <div class="style-controls">
        <div class="style-control">
          <label>æ–‡å­—é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="priorityColorPicker" class="color-picker" value="#dc2626">
            <input type="text" id="priorityColorInput" class="color-text-input" placeholder="#dc2626">
          </div>
        </div>
        <div class="style-control">
          <label>èƒŒæ™¯é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="priorityBgPicker" class="color-picker" value="#fef2f2">
            <input type="text" id="priorityBgInput" class="color-text-input" placeholder="#fef2f2">
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥æœŸå­—æ®µæ ·å¼ -->
    <div class="field-group">
      <div class="field-group-title">
        æ—¥æœŸæ ‡ç­¾ (due, start, end)
        <span class="field-preview" id="datePreview">due:2025-12-31</span>
      </div>
      <div class="style-controls">
        <div class="style-control">
          <label>æ–‡å­—é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="dateColorPicker" class="color-picker" value="#059669">
            <input type="text" id="dateColorInput" class="color-text-input" placeholder="#059669">
          </div>
        </div>
        <div class="style-control">
          <label>èƒŒæ™¯é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="dateBgPicker" class="color-picker" value="#ecfdf5">
            <input type="text" id="dateBgInput" class="color-text-input" placeholder="#ecfdf5">
          </div>
        </div>
      </div>
    </div>

    <!-- URLå­—æ®µæ ·å¼ -->
    <div class="field-group">
      <div class="field-group-title">
        URLé“¾æ¥
        <span class="field-preview" id="urlPreview">url:https://example.com</span>
      </div>
      <div class="style-controls">
        <div class="style-control">
          <label>æ–‡å­—é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="urlColorPicker" class="color-picker" value="#ec4899">
            <input type="text" id="urlColorInput" class="color-text-input" placeholder="#ec4899">
          </div>
        </div>
        <div class="style-control">
          <label>èƒŒæ™¯é¢œè‰²</label>
          <div class="color-input-wrapper">
            <input type="color" id="urlBgPicker" class="color-picker" value="#fdf2f8">
            <input type="text" id="urlBgInput" class="color-text-input" placeholder="#fdf2f8">
          </div>
        </div>
      </div>
    </div>

    <div class="field-style-actions">
      <button id="resetFieldStyles" class="field-style-btn field-style-btn-secondary">é‡ç½®é»˜è®¤</button>
      <button id="applyFieldStyles" class="field-style-btn field-style-btn-primary">åº”ç”¨æ ·å¼</button>
    </div>
  </div>
</div>

<script>
(function() {

/* ========= DOM å…ƒç´ ç¼“å­˜ ========= */
const dom = {
  appTitle: document.getElementById('appTitle'),
  settingsBtn: document.getElementById('settingsBtn'),
  search: document.getElementById('search'),
  clearSearch: document.getElementById('clearSearch'),
  searchHints: document.getElementById('searchHints'),
  status: document.getElementById('status'),
  list: document.getElementById('list'),
  drawer: document.getElementById('drawer'),
  closeDrawer: document.getElementById('closeDrawer'),
  groupBy: document.getElementById('groupBy'),
  sort: document.getElementById('sort'),
  clearDoneBtn: document.getElementById('clearDoneBtn'),
  gistId: document.getElementById('gistId'),
  githubPat: document.getElementById('githubPat'),
  saveGistSettings: document.getElementById('saveGistSettings'),
  pullFromGistBtn: document.getElementById('pullFromGistBtn'),
  pushToGistBtn: document.getElementById('pushToGistBtn'),
  syncStatus: document.getElementById('syncStatus'),
  quickCleanupBtn: document.getElementById('quickCleanupBtn'),
  clearExpiredBtn: document.getElementById('clearExpiredBtn'),
  openEditorBtn: document.getElementById('openEditorBtn'),
  openFieldStyleBtn: document.getElementById('openFieldStyleBtn'),
  exportBtn: document.getElementById('exportBtn'),
  importInput: document.getElementById('importInput'),
  resetBtn: document.getElementById('resetBtn'),
  settingsConfirmHost: document.getElementById('settingsConfirmHost'),
  toast: document.getElementById('toast'),
  editorModal: document.getElementById('editorModal'),
  modalDragHandle: document.getElementById('modalDragHandle'),
  closeEditor: document.getElementById('closeEditor'),
  raw: document.getElementById('raw'),
  applyTxt: document.getElementById('applyTxt'),
  fieldStyleModal: document.getElementById('fieldStyleModal'),
  fieldStyleModalDragHandle: document.getElementById('fieldStyleModalDragHandle'),
  closeFieldStyle: document.getElementById('closeFieldStyle'),
  projectPreview: document.getElementById('projectPreview'),
  contextPreview: document.getElementById('contextPreview'),
  priorityPreview: document.getElementById('priorityPreview'),
  datePreview: document.getElementById('datePreview'),
  urlPreview: document.getElementById('urlPreview'),
  applyFieldStyles: document.getElementById('applyFieldStyles'),
  resetFieldStyles: document.getElementById('resetFieldStyles'),
  // é¢œè‰²è¾“å…¥æ¡†å’Œé€‰æ‹©å™¨ï¼Œç°åœ¨ä¹ŸåŠ å…¥ç¼“å­˜
  projectColorPicker: document.getElementById('projectColorPicker'),
  projectColorInput: document.getElementById('projectColorInput'),
  projectBgPicker: document.getElementById('projectBgPicker'),
  projectBgInput: document.getElementById('projectBgInput'),
  contextColorPicker: document.getElementById('contextColorPicker'),
  contextColorInput: document.getElementById('contextColorInput'),
  contextBgPicker: document.getElementById('contextBgPicker'),
  contextBgInput: document.getElementById('contextBgInput'),
  priorityColorPicker: document.getElementById('priorityColorPicker'),
  priorityColorInput: document.getElementById('priorityColorInput'),
  priorityBgPicker: document.getElementById('priorityBgPicker'),
  priorityBgInput: document.getElementById('priorityBgInput'),
  dateColorPicker: document.getElementById('dateColorPicker'),
  dateColorInput: document.getElementById('dateColorInput'),
  dateBgPicker: document.getElementById('dateBgPicker'),
  dateBgInput: document.getElementById('dateBgInput'),
  urlColorPicker: document.getElementById('urlColorPicker'),
  urlColorInput: document.getElementById('urlColorInput'),
  urlBgPicker: document.getElementById('urlBgPicker'),
  urlBgInput: document.getElementById('urlBgInput'),
};

/* ========= å­˜å‚¨ ========= */
const STORE_KEY = 'todotxt.web.final.v1';
const FIELD_STYLES_KEY = 'todotxt.web.field.styles.v1';
const GIST_PAT_KEY = 'todotxt.gist.pat'; // IMPORTANT: Storing PAT in localStorage is susceptible to XSS. User should be aware.
const GIST_ID_KEY = 'todotxt.gist.id';

function save(lines) { localStorage.setItem(STORE_KEY, JSON.stringify(lines)); }
function load() { try { const s=localStorage.getItem(STORE_KEY); return s? JSON.parse(s): []; } catch(e) { console.error("Failed to load tasks from localStorage:", e); return []; } }

/* ========= å­—æ®µæ ·å¼ç³»ç»Ÿ ========= */
function saveFieldStyles(styles) { 
  localStorage.setItem(FIELD_STYLES_KEY, JSON.stringify(styles)); 
}

function loadFieldStyles() { 
  try { 
    const s = localStorage.getItem(FIELD_STYLES_KEY); 
    return s ? JSON.parse(s) : getDefaultFieldStyles(); 
  } catch { 
    return getDefaultFieldStyles(); 
  } 
}

function getDefaultFieldStyles() {
  return {
    project: { color: '#2563eb', bg: '#eff6ff', border: '#bfdbfe' },
    context: { color: '#7c3aed', bg: '#f3e8ff', border: '#c4b5fd' },
    priority: { color: '#dc2626', bg: '#fef2f2', border: '#fecaca' },
    date: { color: '#059669', bg: '#ecfdf5', border: '#a7f3d0' },
    url: { color: '#ec4899', bg: '#fdf2f8', border: '#f9a8d4' }
  };
}

function applyFieldStyles(styles) {
  const root = document.documentElement;
  root.style.setProperty('--project-color', styles.project.color);
  root.style.setProperty('--project-bg', styles.project.bg);
  root.style.setProperty('--project-border', styles.project.border);
  
  root.style.setProperty('--context-color', styles.context.color);
  root.style.setProperty('--context-bg', styles.context.bg);
  root.style.setProperty('--context-border', styles.context.border);
  
  root.style.setProperty('--priority-color', styles.priority.color);
  root.style.setProperty('--priority-bg', styles.priority.bg);
  root.style.setProperty('--priority-border', styles.priority.border);
  
  root.style.setProperty('--date-color', styles.date.color);
  root.style.setProperty('--date-bg', styles.date.bg);
  root.style.setProperty('--date-border', styles.date.border);
  
  root.style.setProperty('--url-color', styles.url.color);
  root.style.setProperty('--url-bg', styles.url.bg);
  root.style.setProperty('--url-border', styles.url.border);
}

// åˆå§‹åŒ–å­—æ®µæ ·å¼
let currentFieldStyles = loadFieldStyles();
applyFieldStyles(currentFieldStyles);

/* ========= å·¥å…· ========= */
const pad = n => String(n).padStart(2,'0');
function debounce(fn, wait=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
function parseDateMaybe(s) {
  if (!s) return null;
  const norm = s.replace(' ', 'T');
  if (/^\d{4}-\d{2}-\d{2}$/.test(norm)) return new Date(norm+'T00:00:00');
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(norm)) return new Date(norm+':00');
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(norm)) return new Date(norm);
  const d = new Date(norm); return isNaN(d)? null : d;
}
function fmtDate(dt, withTime=true, withSeconds=false) {
  if (!dt) return '';
  const y=dt.getFullYear(), m=pad(dt.getMonth()+1), d=pad(dt.getDate()),
        hh=pad(dt.getHours()), mm=pad(dt.getMinutes()), ss=pad(dt.getSeconds());
  if (!withTime) return `${y}-${m}-${d}`;
  return withSeconds? `${y}-${m}-${d}T${hh}:${mm}:${ss}` : `${y}-${m}-${d}T${hh}:${mm}`;
}
function addInterval(dt, rec) {
  const m = String(rec||'').match(/^(\d+)([dwmy])$/i);
  if (!m) return new Date(dt);
  const n = parseInt(m[1],10), u = m[2].toLowerCase();
  const nd = new Date(dt);
  if (u==='d') nd.setDate(nd.getDate()+n);
  else if (u==='w') nd.setDate(nd.getDate()+7*n);
  else if (u==='m') nd.setMonth(nd.getMonth()+n);
  else if (u==='y') nd.setFullYear(nd.getFullYear()+n);
  return nd;
}
function humanDiff(ms) {
  const s = Math.floor(Math.abs(ms)/1000);
  const m = Math.floor(s/60), h = Math.floor(m/60), d = Math.floor(h/24);
  if (d>0) return h%24? `${d}å¤©${h%24}å°æ—¶` : `${d}å¤©`;
  if (h>0) return m%60? `${h}å°æ—¶${m%60}åˆ†é’Ÿ` : `${h}å°æ—¶`;
  if (m>0) return `${m}åˆ†é’Ÿ`;
  return `${s}ç§’`;
}
function showToast(msg, ms=1400){
  const t = dom.toast;
  t.textContent = msg; t.classList.add('show');
  clearTimeout(showToast._tid);
  showToast._tid = setTimeout(()=> t.classList.remove('show'), ms);
}

/* ========= è§£æ / æ ¼å¼åŒ– ========= */
function parseLine(line) {
  const o = { raw:line, done:false, priority:null, completedDate:null, createdDate:null, text:'', projects:[], contexts:[], kv:{} };
  let s = (line||'').trim(); if (!s) return null;

  if (s.startsWith('x ')) {
    o.done = true; s = s.slice(2).trim();
    const m = s.match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{4}-\d{2}-\d{2}))?\s+(.*)$/);
    if (m) { o.completedDate=m[1]; if (m[2]) o.createdDate=m[2]; s=m[3]; }
  } else {
    const mp = s.match(/^\(([A-Z])\)\s+(.*)$/);
    if (mp) { o.priority = mp[1]; s = mp[2]; }
    const mc = s.match(/^(\d{4}-\d{2}-\d{2})\s+(.*)$/);
    if (mc) { o.createdDate = mc[1]; s = mc[2]; }
  }

  const tokens = s.split(/\s+/);
  const rest = [];
  for (const t of tokens) {
    if (t.startsWith('+') && t.length>1) o.projects.push(t);
    else if (t.startsWith('@') && t.length>1) o.contexts.push(t);
    else if (/^[A-Za-z_][\w-]*:/.test(t)) {
      const idx = t.indexOf(':'), k = t.slice(0,idx).toLowerCase(), v = t.slice(idx+1);
      o.kv[k] = v;
    } else rest.push(t);
  }
  o.text = rest.join(' ').trim();
  o.raw = formatLine(o); // Ensure raw field is up-to-date after parsing
  return o;
}
function formatLine(o) {
  const parts = [];
  if (o.done) {
    parts.push('x');
    if (o.completedDate) parts.push(o.completedDate);
    if (o.createdDate) parts.push(o.createdDate);
  } else {
    if (o.priority) parts.push(`(${o.priority})`);
    if (o.createdDate) parts.push(o.createdDate);
  }
  if (o.text) parts.push(o.text);
  for (const p of o.projects) parts.push(p);
  for (const c of o.contexts) parts.push(c);
  const order = ['due','t','start','end','rec','count','until','doneat','id'];
  const keys = Object.keys(o.kv);
  const sorted = [...order.filter(k=>keys.includes(k)), ...keys.filter(k=>!order.includes(k)).sort()];
  for (const k of sorted) parts.push(`${k}:${o.kv[k]}`);
  return parts.join(' ').trim();
}

/* ========= é‡å¤é€»è¾‘ ========= */
function completeAndMaybeRecur(task) {
  const todayDate = fmtDate(new Date(), false);
  const nowFull = fmtDate(new Date(), true, true);
  task.done = true;
  task.completedDate = todayDate;
  task.kv['doneat'] = nowFull;

  const rec = task.kv['rec'];
  if (!rec) return null;

  const next = JSON.parse(JSON.stringify(task));

  let currentStart = parseDateMaybe(task.kv['start']);
  let currentEnd   = parseDateMaybe(task.kv['end']);
  let currentDue   = parseDateMaybe(task.kv['due']);
  let currentT     = parseDateMaybe(task.kv['t']);

  const now = new Date();
  const todayStartOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let nextStart = currentStart ? addInterval(currentStart, rec) : null;
  let nextEnd   = currentEnd   ? addInterval(currentEnd,   rec) : null;
  let nextDue   = currentDue   ? addInterval(currentDue,   rec) : null;
  let nextT     = currentT     ? addInterval(currentT,     rec) : null;

  const until = parseDateMaybe(task.kv['until']);
  const anchorNext = nextStart || nextDue || nextT;
  if (until && anchorNext && anchorNext > until) {
    return null;
  }
  
  let nextCount = task.kv['count'];
  if (nextCount) {
    const n = Math.max(0, parseInt(nextCount, 10) - 1);
    if (n <= 0) return null;
    nextCount = String(n);
  }

  next.done = false;
  next.completedDate = null;
  delete next.kv['doneat'];
  next.createdDate = todayDate;

  if (nextStart) next.kv['start'] = fmtDate(nextStart, true, false); else delete next.kv['start'];
  if (nextEnd) next.kv['end'] = fmtDate(nextEnd, true, false); else delete next.kv['end'];
  if (nextDue) next.kv['due'] = fmtDate(nextDue, true, false); else delete next.kv['due'];
  if (nextT) next.kv['t'] = fmtDate(nextT, true, false); else delete next.kv['t'];
  if (nextCount) next.kv['count'] = nextCount; else delete next.kv['count'];

  next.raw = formatLine(next);
  return next;
}

/* ========= çŠ¶æ€ & æ’åº ========= */
let tasks = load().map(parseLine).filter(Boolean);
function collectFacets(ts) {
  const proj = new Set(), ctx = new Set();
  ts.forEach(t => { t.projects.forEach(p=>proj.add(p)); t.contexts.forEach(c=>ctx.add(c)); });
  return {projects:[...proj].sort(), contexts:[...ctx].sort()};
}
function sortTasks(arr, spec="priority,due,start,text") {
  const keys = spec.split(',').map(s=>s.trim()).filter(Boolean);
  return arr.slice().sort((a,b)=>{
    if (a.done !== b.done) return a.done ? 1 : -1;
    for (const k of keys) {
      if (k === 'priority') {
        const pa = a.priority? a.priority.charCodeAt(0): 999;
        const pb = b.priority? b.priority.charCodeAt(0): 999;
        if (pa !== pb) return pa - pb;
      } else if (k === 'due') {
        const da = parseDateMaybe(a.kv['due']), db = parseDateMaybe(b.kv['due']);
        if (da && db && da.getTime() !== db.getTime()) return da - db;
        if (da && !db) return -1;
        if (!da && db) return 1;
      } else if (k === 'start') {
        const sa = parseDateMaybe(a.kv['start']), sb = parseDateMaybe(b.kv['start']);
        if (sa && sb && sa.getTime() !== sb.getTime()) return sa - sb;
        if (sa && !sb) return -1;
        if (!sa && sb) return 1;
      } else if (k === 'countdown') {
        const now = new Date();
        const getUrgency = (t) => {
          if (t.done) return 999999;
          const due = parseDateMaybe(t.kv['due']);
          const end = parseDateMaybe(t.kv['end']);
          const start = parseDateMaybe(t.kv['start']);
          
          if (due) return due.getTime() - now.getTime();
          if (end) return end.getTime() - now.getTime();
          if (start && start > now) return start.getTime() - now.getTime();
          return 999999;
        };
        const ua = getUrgency(a), ub = getUrgency(b);
        if (ua !== ub) return ua - ub;
      } else if (k === 'created') {
        const ca = parseDateMaybe(a.createdDate), cb = parseDateMaybe(b.createdDate);
        if (ca && cb && ca.getTime() !== cb.getTime()) return cb - ca;
        if (ca && !cb) return -1;
        if (!ca && cb) return 1;
      } else if (k === 'text') {
        const cmp = (a.text||'').localeCompare(b.text||'');
        if (cmp !== 0) return cmp;
      }
    }
    return 0;
  });
}

// åˆ†ç»„å‡½æ•°
function groupTasks(tasks, groupBy) {
  if (groupBy === 'none') return [{ name: 'å…¨éƒ¨ä»»åŠ¡', tasks }];
  
  const groups = {};
  
  for (const task of tasks) {
    let groupKey = 'æœªåˆ†ç±»';
    
    switch (groupBy) {
      case 'project':
        if (task.projects.length > 0) {
          groupKey = task.projects[0];
        }
        break;
      case 'context':
        if (task.contexts.length > 0) {
          groupKey = task.contexts[0];
        }
        break;
      case 'priority':
        if (task.priority) {
          groupKey = `ä¼˜å…ˆçº§ ${task.priority}`;
        } else {
          groupKey = 'æ— ä¼˜å…ˆçº§';
        }
        break;
      case 'status':
        if (task.done) {
          groupKey = 'å·²å®Œæˆ';
        } else {
          const now = new Date();
          const today = new Date(now.toDateString());
          const due = parseDateMaybe(task.kv['due']);
          const end = parseDateMaybe(task.kv['end']);
          
          if ((due && due < today) || (end && end < now)) {
            groupKey = 'å·²è¿‡æœŸ';
          } else {
            groupKey = 'å¾…å¤„ç†'; // Renamed for clarity: Was 'æœ‰æˆªæ­¢æ—¶é—´' or 'æ— æˆªæ­¢æ—¶é—´'
          }
        }
        break;
    }
    
    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(task);
  }
  
  const result = Object.entries(groups).map(([name, tasks]) => ({ name, tasks }));
  
  result.sort((a, b) => {
    if (groupBy === 'priority') {
      const getPriorityOrder = (name) => {
        if (name === 'æ— ä¼˜å…ˆçº§') return 999;
        const match = name.match(/ä¼˜å…ˆçº§ ([A-Z])/);
        return match ? match[1].charCodeAt(0) : 999;
      };
      return getPriorityOrder(a.name) - getPriorityOrder(b.name);
    } else if (groupBy === 'status') {
      const statusOrder = { 'å·²è¿‡æœŸ': 0, 'å¾…å¤„ç†': 1, 'å·²å®Œæˆ': 2, 'æœªåˆ†ç±»': 3 }; // Updated order
      return (statusOrder[a.name] || 999) - (statusOrder[b.name] || 999);
    }
    return a.name.localeCompare(b.name);
  });
  
  return result;
}

/* ========= å€’è®¡æ—¶ ========= */
function describeTaskTime(t, now=new Date()){
  if (t.done) return '';
  const start = parseDateMaybe(t.kv['start']);
  const end = parseDateMaybe(t.kv['end']);
  const due = parseDateMaybe(t.kv['due']);

  if (start && now < start) return humanDiff(start-now)+'åå¼€å§‹';
  if (start && end && now >= start && now < end) return 'è¿˜æœ‰ '+humanDiff(end-now)+' ç»“æŸ';
  if (end && now >= end) return 'å·²ç»“æŸ '+humanDiff(now-end)+' å‰';

  if (due) {
    if (now < due) return 'è¿˜æœ‰ '+humanDiff(due-now)+' æˆªæ­¢';
    return 'å·²è¿‡æœŸ '+humanDiff(now-due);
  }
  return '';
}

/* ========= è§†å›¾åŸºç¡€ ========= */
function badge(text, cls=''){ const s=document.createElement('span'); s.className='badge'+(cls? ' '+cls:''); s.textContent=text; return s; }

/**
 * Updates the raw text editor content with the current tasks.
 */
function syncRawEditorWithValue() {
  if (dom.editorModal.classList.contains('open') && dom.raw) {
    dom.raw.value = tasks.map(formatLine).join('\n');
  }
}

// Centralized function to update tasks, save, and re-render
function setTasks(arr, {updateRawEditor=true, shouldSave=true}={}) {
  tasks = arr;
  if (shouldSave) {
    save(tasks.map(formatLine));
  }
  if (updateRawEditor) {
    syncRawEditorWithValue();
  }
  render(); // Always re-render UI after task changes
}

function inlineEditTask(t, row) {
  const current = formatLine(t);
  const input = document.createElement('input');
  input.className='input'; input.value = current; input.style.width='100%';
  const apply = ()=> {
    const p = parseLine(input.value);
    if (!p) return;
    const idx = tasks.indexOf(t);
    const arr = tasks.slice(); arr[idx]=p; setTasks(arr); // Use setTasks
    showToast('å·²æ›´æ–°ä»»åŠ¡');
  };
  input.addEventListener('keydown', (e)=> {
    if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); apply(); }
    if (e.key==='Escape') render();
  });
  row.querySelector('.title').replaceWith(input);
  input.focus(); input.select();
}

/* ========= æ¸²æŸ“ ========= */
function render() {
  const list = dom.list;
  const status = dom.status.value;
  const sortSpec = dom.sort ? dom.sort.value : 'priority,due,start,text';
  const groupBy = dom.groupBy ? dom.groupBy.value : 'none';
  const searchVal = dom.search.value.trim();

  // Sort tasks (tasks array is directly modified by sortTasks)
  tasks = sortTasks(tasks, sortSpec);

  // Check and display/hide quick cleanup button
  const now = new Date();
  const today = new Date(now.toDateString());
  const hasExpired = tasks.some(t => {
    if (t.done) return false;
    const due = parseDateMaybe(t.kv['due']);
    const end = parseDateMaybe(t.kv['end']);
    return (due && due < today) || (end && end < now);
  });
  dom.quickCleanupBtn.style.display = hasExpired ? 'flex' : 'none';
  dom.quickCleanupBtn.textContent = hasExpired ? 'ğŸ§¹' : ''; // Add text for clarity

  // Filter tasks based on search and status
  let view = filterTasks(tasks, searchVal, status);

  // Group filtered tasks
  const groups = groupTasks(view, groupBy);

  // Render UI
  list.innerHTML = '';
  const fragment = document.createDocumentFragment();
  
  for (const group of groups) {
    if (groupBy !== 'none') {
      const groupContainer = document.createElement('div');
      groupContainer.className = 'group-container';
      
      const groupHeader = document.createElement('div');
      groupHeader.className = 'group-header';
      const groupNameSpan = document.createElement('span'); groupNameSpan.textContent = group.name;
      const groupCountSpan = document.createElement('span'); groupCountSpan.className = 'group-count'; groupCountSpan.textContent = group.tasks.length;
      groupHeader.append(groupNameSpan, groupCountSpan);
      
      const groupTasks = document.createElement('div');
      groupTasks.className = 'group-tasks';
      
      groupContainer.appendChild(groupHeader);
      groupContainer.appendChild(groupTasks);
      
      renderTasks(group.tasks, groupTasks);
      fragment.appendChild(groupContainer);
    } else {
      renderTasks(group.tasks, fragment);
    }
  }
  list.appendChild(fragment);

  // Show empty state if no tasks
  if (list.children.length === 0) {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    const emptyTitle = document.createElement('h3');
    emptyTitle.textContent = 'ç©ºç©ºå¦‚ä¹Ÿ';
    emptyState.append(emptyTitle, 'æ­¤è§†å›¾ä¸‹æ²¡æœ‰ä»»åŠ¡');
    list.appendChild(emptyState);
  }
}

// Helper to filter tasks based on search and status
function filterTasks(tasksToFilter, searchVal, status) {
  let filtered = tasksToFilter.slice();

  if (searchVal) {
    const terms = searchVal.split(/\s+/).map(s=>s.toLowerCase().trim()).filter(s=>s);
    filtered = filtered.filter(t => {
      const searchFields = [
        t.text || '',
        ...t.projects,
        ...t.contexts,
        t.priority ? `(${t.priority})` : '',
        Object.entries(t.kv).map(([k,v]) => `${k}:${v}`).join(' ')
      ].join(' ').toLowerCase();
      
      return terms.every(term => {
        if (term.startsWith('+')) return t.projects.some(p => p.toLowerCase().includes(term));
        if (term.startsWith('@')) return t.contexts.some(c => c.toLowerCase().includes(term));
        if (term.startsWith('pri:') || term.startsWith('priority:')) {
          const pri = term.split(':')[1];
          return t.priority && t.priority.toLowerCase() === pri;
        }
        if (term.includes(':')) {
          const [key, val] = term.split(':', 2);
          return t.kv[key] && String(t.kv[key]).toLowerCase().includes(val); // Ensure kv[key] is string
        }
        return searchFields.includes(term);
      });
    });
  }

  const now = new Date();
  const today = new Date(now.toDateString());

  if (status === 'open') {
    filtered = filtered.filter(t => !t.done);
  } else if (status === 'done') {
    filtered = filtered.filter(t => t.done);
  } else if (status === 'ongoing') {
    filtered = filtered.filter(t => {
      if (t.done) return false;
      const start = parseDateMaybe(t.kv['start']);
      const end = parseDateMaybe(t.kv['end']);
      const due = parseDateMaybe(t.kv['due']);
      if (start && now >= start && (!end || now < end)) return true;
      if (!start && (due || end)) {
        const deadline = due || end;
        return deadline >= (due ? today : now);
      }
      if (!start && !end && !due) return true;
      return false;
    });
  } else if (status === 'pending') {
    filtered = filtered.filter(t => {
      if (t.done) return false;
      const start = parseDateMaybe(t.kv['start']);
      return start && now < start;
    });
  } else if (status === 'expired') {
    filtered = filtered.filter(t => {
      if (t.done) return false;
      const due = parseDateMaybe(t.kv['due']);
      const end = parseDateMaybe(t.kv['end']);
      return (due && due < today) || (end && end < now);
    });
  } else if (status === 'actionable') {
    filtered = filtered.filter(t => {
      if (t.done) return false;
      let isOngoing = false;
      const start = parseDateMaybe(t.kv['start']);
      const end = parseDateMaybe(t.kv['end']);
      const due = parseDateMaybe(t.kv['due']);
      
      if (start && now >= start && (!end || now < end)) isOngoing = true;
      if (!start && (due || end)) {
        const deadline = due || end;
        if (deadline >= (due ? today : now)) isOngoing = true;
      }
      if (!start && !end && !due) isOngoing = true;
      if (isOngoing) return true;

      if ((due && due < today) || (end && end < now)) return true;
      return false;
    });
  }
  return filtered;
}

/* ========= Gist åŒæ­¥åŠŸèƒ½ (æ‰‹åŠ¨æ‹‰å–/æ¨é€) ========= */
const GIST_FILENAME = 'todo.txt';

function loadGistSettings() {
  dom.gistId.value = localStorage.getItem(GIST_ID_KEY) || '';
  dom.githubPat.value = localStorage.getItem(GIST_PAT_KEY) || '';
}

async function pullFromGist() {
  const pat = localStorage.getItem(GIST_PAT_KEY);
  const gistId = localStorage.getItem(GIST_ID_KEY);

  if (!pat || !gistId) {
    showToast('è¯·å…ˆè®¾ç½® Gist ID å’Œ PAT');
    dom.drawer.classList.add('open');
    dom.gistId.focus();
    return;
  }

  if (!confirm('ç¡®è®¤ä» Gist æ‹‰å–æ•°æ®ï¼Ÿ\nè¿™å°†è¦†ç›–æ‚¨å½“å‰çš„æœ¬åœ°ä»»åŠ¡åˆ—è¡¨ã€‚')) {
    return;
  }

  dom.pullFromGistBtn.disabled = true;
  dom.pushToGistBtn.disabled = true;
  dom.syncStatus.textContent = 'æ­£åœ¨æ‹‰å–...';
  showToast('æ­£åœ¨ä» Gist æ‹‰å–...');

  try {
    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: {
        'Authorization': `token ${pat}`,
        'Accept': 'application/vnd.github.v3+json',
      }
    });
    if (!response.ok) {
      let errorMsg = `Gist æ‹‰å–å¤±è´¥: ${response.statusText}`;
      if (response.status === 401 || response.status === 403) {
        errorMsg += ' (è¯·æ£€æŸ¥æ‚¨çš„PATæ˜¯å¦æ­£ç¡®å¹¶æ‹¥æœ‰gistæƒé™)';
      }
      throw new Error(errorMsg);
    }
    const gistData = await response.json();
    const remoteContent = gistData.files[GIST_FILENAME]?.content;
    if (typeof remoteContent !== 'string') {
      throw new Error(`åœ¨ Gist ä¸­æœªæ‰¾åˆ°æ–‡ä»¶: ${GIST_FILENAME}`);
    }

    const remoteLines = remoteContent.split('\n').map(s => s.trim()).filter(Boolean);
    const pulledTasks = remoteLines.map(parseLine).filter(Boolean);

    setTasks(pulledTasks, { updateRawEditor: true, shouldSave: true });

    dom.syncStatus.textContent = `ä¸Šæ¬¡åŒæ­¥: ${new Date().toLocaleString()}`;
    showToast('ä» Gist æ‹‰å–æˆåŠŸï¼');

  } catch (error) {
    console.error('Gist æ‹‰å–é”™è¯¯:', error);
    dom.syncStatus.textContent = `æ‹‰å–å¤±è´¥: ${error.message}`;
    showToast(`æ‹‰å–å¤±è´¥: ${error.message}`, 3000);
  } finally {
    dom.pullFromGistBtn.disabled = false;
    dom.pushToGistBtn.disabled = false;
  }
}

async function pushToGist() {
  const pat = localStorage.getItem(GIST_PAT_KEY);
  const gistId = localStorage.getItem(GIST_ID_KEY);

  if (!pat || !gistId) {
    showToast('è¯·å…ˆè®¾ç½® Gist ID å’Œ PAT');
    dom.drawer.classList.add('open');
    dom.gistId.focus();
    return;
  }

  if (!confirm('ç¡®è®¤æ¨é€åˆ° Gistï¼Ÿ\nè¿™å°†è¦†ç›–æ‚¨åœ¨ Gist ä¸Šçš„ä»»åŠ¡åˆ—è¡¨ã€‚')) {
    return;
  }

  dom.pullFromGistBtn.disabled = true;
  dom.pushToGistBtn.disabled = true;
  dom.syncStatus.textContent = 'æ­£åœ¨æ¨é€...';
  showToast('æ­£åœ¨æ¨é€åˆ° Gist...');

  const content = tasks.map(formatLine).join('\n');

  try {
    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `token ${pat}`,
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({
        files: {
          [GIST_FILENAME]: {
            content: content
          }
        }
      })
    });

    if (!response.ok) {
      let errorMsg = `Gist ä¸Šä¼ å¤±è´¥: ${response.statusText}`;
      if (response.status === 401 || response.status === 403) {
        errorMsg += ' (è¯·æ£€æŸ¥æ‚¨çš„PATæ˜¯å¦æ­£ç¡®å¹¶æ‹¥æœ‰gistæƒé™)';
      }
      throw new Error(errorMsg);
    }
    dom.syncStatus.textContent = `ä¸Šæ¬¡åŒæ­¥: ${new Date().toLocaleString()}`;
    showToast('æ¨é€åˆ° Gist æˆåŠŸï¼');

  } catch (error) {
    console.error('Gist æ¨é€é”™è¯¯:', error);
    dom.syncStatus.textContent = `æ¨é€å¤±è´¥: ${error.message}`;
    showToast(`æ¨é€å¤±è´¥: ${error.message}`, 3000);
  } finally {
    dom.pullFromGistBtn.disabled = false;
    dom.pushToGistBtn.disabled = false;
  }
}

function renderTasks(tasksToRender, container) {
  for (const t of tasksToRender) {
    const row = document.createElement('div');
    row.className = 'task'+(t.done?' done':'');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=t.done;
    cb.addEventListener('change', () => {
      if (!t.done) {
        const next = completeAndMaybeRecur(t);
        t.done = true; t.raw = formatLine(t);
        const arr = tasks.slice();
        if (next) arr.splice(tasks.indexOf(t)+1, 0, next);
        setTasks(arr);
        showToast('å·²å®Œæˆ');
      } else {
        t.done = false; t.completedDate = null; delete t.kv['doneat']; t.raw = formatLine(t);
        setTasks(tasks);
        showToast('å·²æ¢å¤ä¸ºæœªå®Œæˆ');
      }
    });

    const body = document.createElement('div');

    const titleEl = document.createElement('div');
    titleEl.className = 'title';
    titleEl.textContent = t.text || '(æ— æ ‡é¢˜)';
    titleEl.addEventListener('dblclick', ()=> inlineEditTask(t, row));

    const meta = document.createElement('div'); meta.className='meta';
    if (t.priority) meta.append(badge(`P:${t.priority}`,'pri'));

    for (const p of t.projects) {
      const b = badge(p); b.classList.add('link', 'proj');
      b.addEventListener('click', ()=> { 
        dom.search.value = p;
        dom.clearSearch.style.display = 'block';
        render(); 
      });
      meta.append(b);
    }
    for (const c of t.contexts) {
      const b = badge(c); b.classList.add('link', 'ctx');
      b.addEventListener('click', ()=> { 
        dom.search.value = c;
        dom.clearSearch.style.display = 'block';
        render(); 
      });
      meta.append(b);
    }

    const due = t.kv['due'], start = t.kv['start'], end = t.kv['end'], rec = t.kv['rec'];
    const count = t.kv['count'], until = t.kv['until'];
    if (due) {
      const d=parseDateMaybe(due); const today0 = new Date(new Date().toDateString());
      const overdue = d && !t.done && d < today0;
      meta.append(badge(`due:${due}`, overdue?'over':'due'));
    }
    if (start) meta.append(badge(`start:${start}`,'start'));
    if (end)   meta.append(badge(`end:${end}`,'start'));
    if (rec)   meta.append(badge(`rec:${rec}`,'rec'));
    if (count) meta.append(badge(`count:${count}`));
    if (until) meta.append(badge(`until:${until}`));

    const known = new Set(['due','t','start','end','rec','count','until','doneat','id']);
    for (const k of Object.keys(t.kv).sort()) {
      if (!known.has(k)) {
        const value = t.kv[k];
        if (value.startsWith('http://') || value.startsWith('https://')) {
          const urlBadge = badge(`${k}:${value}`, 'url');
          urlBadge.addEventListener('click', () => {
            window.open(value, '_blank');
          });
          meta.append(urlBadge);
        } else {
          const customBadge = badge(`${k}:${value}`);
          // For custom key-value pairs, if they contain potentially unsafe HTML,
          // `textContent` provides basic XSS protection.
          meta.append(customBadge);
        }
      }
    }

    const hasTiming = !!(start || end || due);
    if (t.done) {
      const timeBadge = document.createElement('span'); timeBadge.className='badge time';
      const doneat = t.kv['doneat'] || (t.completedDate? fmtDate(parseDateMaybe(t.completedDate), true, true) : '');
      timeBadge.textContent = doneat ? `å®Œæˆäº ${doneat.replace('T', ' ')}` : 'å·²å®Œæˆ';
      meta.append(timeBadge);
      t._descEl = timeBadge;
    } else if (hasTiming) {
      const timeBadge = document.createElement('span'); timeBadge.className='badge time';
      const timeDesc = describeTaskTime(t);
      timeBadge.textContent = timeDesc;
      
      const now = new Date();
      const dueDate = parseDateMaybe(due);
      const endDate = parseDateMaybe(end);
      const isExpired = (dueDate && dueDate < today) || (endDate && endDate < now);
      
      if (isExpired) {
        timeBadge.classList.add('expired');
      }
      
      meta.append(timeBadge);
      t._descEl = timeBadge;
    } else {
      t._descEl = null;
    }

    body.append(titleEl, meta);

    const btnRaw = document.createElement('button'); btnRaw.className='btn'; btnRaw.textContent='åŸæ–‡';
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.textContent='åˆ é™¤';

    const actions = document.createElement('div'); actions.className='actions';
    const rawBox = document.createElement('div'); rawBox.className='rawbox';
    const rawText = document.createElement('div'); rawText.className='rawtext'; rawText.textContent = formatLine(t);
    const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='å¤åˆ¶';
    
    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(formatLine(t)); showToast('å·²å¤åˆ¶'); }catch{}
    });
    rawBox.append(rawText, copyBtn);
    btnRaw.addEventListener('click', ()=> rawBox.style.display = rawBox.style.display==='none' || rawBox.style.display==='' ? 'flex' : 'none');

    let confirmBar = null;
    btnDel.addEventListener('click', ()=>{
      if (confirmBar) return;
      confirmBar = document.createElement('div');
      confirmBar.className='confirm-bar';
      const info = document.createElement('span'); info.textContent='ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ';
      const yes = document.createElement('button'); yes.className='btn destructive'; yes.textContent='åˆ é™¤';
      const no  = document.createElement('button'); no.className='btn'; no.textContent='å–æ¶ˆ';
      yes.addEventListener('click', ()=> { setTasks(tasks.filter(x=>x!==t)); showToast('å·²åˆ é™¤'); });
      no.addEventListener('click', ()=> { confirmBar.remove(); confirmBar=null; });
      confirmBar.append(info, yes, no);
      body.append(confirmBar);
    });

    actions.append(btnRaw, btnDel);

    row.append(cb, body, actions, rawBox);
    container.append(row);
  }
}

/* ========= å¯¼å…¥/å¯¼å‡º/åŒæ­¥ ========= */
function applyRawText(text) {
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0);
  const parsed = lines.map(parseLine).filter(Boolean);
  // When applying raw text, update tasks, but don't re-read from the raw textarea (it's the source)
  setTasks(parsed, {updateRawEditor:false, shouldSave:true});
  syncRawEditorWithValue(); // Ensure the raw editor reflects applied text
  showToast('å·²åº”ç”¨æ–‡æœ¬');
}
function exportTxt() {
  const blob = new Blob([tasks.map(formatLine).join('\n')], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'todo.txt';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('å·²å¯¼å‡º');
}

/* ========= å­—æ®µæ ·å¼é…ç½®åŠŸèƒ½ ========= */
const fieldStyleModal = dom.fieldStyleModal;

// æ›´æ–°é¢„è§ˆ
function updateFieldStylePreviews() {
  dom.projectPreview.style.color = currentFieldStyles.project.color;
  dom.projectPreview.style.backgroundColor = currentFieldStyles.project.bg;
  dom.projectPreview.style.borderColor = currentFieldStyles.project.border;
  
  dom.contextPreview.style.color = currentFieldStyles.context.color;
  dom.contextPreview.style.backgroundColor = currentFieldStyles.context.bg;
  dom.contextPreview.style.borderColor = currentFieldStyles.context.border;
  
  dom.priorityPreview.style.color = currentFieldStyles.priority.color;
  dom.priorityPreview.style.backgroundColor = currentFieldStyles.priority.bg;
  dom.priorityPreview.style.borderColor = currentFieldStyles.priority.border;
  
  dom.datePreview.style.color = currentFieldStyles.date.color;
  dom.datePreview.style.backgroundColor = currentFieldStyles.date.bg;
  dom.datePreview.style.borderColor = currentFieldStyles.date.border;
  
  dom.urlPreview.style.color = currentFieldStyles.url.color;
  dom.urlPreview.style.backgroundColor = currentFieldStyles.url.bg;
  dom.urlPreview.style.borderColor = currentFieldStyles.url.border;
}

// æ›´æ–°è¾“å…¥æ¡†
function updateFieldStyleInputs() {
  dom.projectColorPicker.value = currentFieldStyles.project.color;
  dom.projectColorInput.value = currentFieldStyles.project.color;
  dom.projectBgPicker.value = currentFieldStyles.project.bg;
  dom.projectBgInput.value = currentFieldStyles.project.bg;
  
  dom.contextColorPicker.value = currentFieldStyles.context.color;
  dom.contextColorInput.value = currentFieldStyles.context.color;
  dom.contextBgPicker.value = currentFieldStyles.context.bg;
  dom.contextBgInput.value = currentFieldStyles.context.bg;
  
  dom.priorityColorPicker.value = currentFieldStyles.priority.color;
  dom.priorityColorInput.value = currentFieldStyles.priority.color;
  dom.priorityBgPicker.value = currentFieldStyles.priority.bg;
  dom.priorityBgInput.value = currentFieldStyles.priority.bg;
  
  dom.dateColorPicker.value = currentFieldStyles.date.color;
  dom.dateColorInput.value = currentFieldStyles.date.color;
  dom.dateBgPicker.value = currentFieldStyles.date.bg;
  dom.dateBgInput.value = currentFieldStyles.date.bg;
  
  dom.urlColorPicker.value = currentFieldStyles.url.color;
  dom.urlColorInput.value = currentFieldStyles.url.color;
  dom.urlBgPicker.value = currentFieldStyles.url.bg;
  dom.urlBgInput.value = currentFieldStyles.url.bg;
}

// å®æ—¶é¢„è§ˆ
function previewFieldStyles(styles) {
  applyFieldStyles(styles);
  updateFieldStylePreviews();
}

// æ‰“å¼€å­—æ®µæ ·å¼é…ç½®
dom.openFieldStyleBtn.addEventListener('click', () => {
  updateFieldStyleInputs();
  updateFieldStylePreviews();
  fieldStyleModal.classList.add('open');
});

// å…³é—­å­—æ®µæ ·å¼é…ç½®
dom.closeFieldStyle.addEventListener('click', () => {
  fieldStyleModal.classList.remove('open');
  // æ¢å¤åˆ°ä¿å­˜çš„æ ·å¼
  currentFieldStyles = loadFieldStyles();
  applyFieldStyles(currentFieldStyles);
  updateFieldStylePreviews();
});

// è®¾ç½®é¢œè‰²è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
function setupColorInputs(fieldType) {
  const colorPicker = dom[`${fieldType}ColorPicker`];
  const colorInput = dom[`${fieldType}ColorInput`];
  const bgPicker = dom[`${fieldType}BgPicker`];
  const bgInput = dom[`${fieldType}BgInput`];
  
  colorPicker.addEventListener('input', (e) => {
    const newStyles = JSON.parse(JSON.stringify(currentFieldStyles));
    newStyles[fieldType].color = e.target.value;
    colorInput.value = e.target.value;
    currentFieldStyles = newStyles;
    previewFieldStyles(newStyles);
  });
  
  colorInput.addEventListener('input', (e) => {
    const color = e.target.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
      const newStyles = JSON.parse(JSON.stringify(currentFieldStyles));
      newStyles[fieldType].color = color;
      colorPicker.value = color;
      currentFieldStyles = newStyles;
      previewFieldStyles(newStyles);
    }
  });
  
  bgPicker.addEventListener('input', (e) => {
    const newStyles = JSON.parse(JSON.stringify(currentFieldStyles));
    newStyles[fieldType].bg = e.target.value;
    const rgb = hexToRgb(e.target.value);
    if (rgb) {
      const darkerRgb = {
        r: Math.max(0, rgb.r - 30),
        g: Math.max(0, rgb.g - 30),
        b: Math.max(0, rgb.b - 30)
      };
      newStyles[fieldType].border = rgbToHex(darkerRgb.r, darkerRgb.g, darkerRgb.b);
    }
    bgInput.value = e.target.value;
    currentFieldStyles = newStyles;
    previewFieldStyles(newStyles);
  });
  
  bgInput.addEventListener('input', (e) => {
    const color = e.target.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
      const newStyles = JSON.parse(JSON.stringify(currentFieldStyles));
      newStyles[fieldType].bg = color;
      const rgb = hexToRgb(color);
      if (rgb) {
        const darkerRgb = {
          r: Math.max(0, rgb.r - 30),
          g: Math.max(0, rgb.g - 30),
          b: Math.max(0, rgb.b - 30)
        };
        newStyles[fieldType].border = rgbToHex(darkerRgb.r, darkerRgb.g, darkerRgb.b);
      }
      bgPicker.value = color;
      currentFieldStyles = newStyles;
      previewFieldStyles(newStyles);
    }
  });
}

// é¢œè‰²è½¬æ¢å·¥å…·å‡½æ•°
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function rgbToHex(r, g, b) {
  return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// åˆå§‹åŒ–æ‰€æœ‰å­—æ®µçš„é¢œè‰²è¾“å…¥
['project', 'context', 'priority', 'date', 'url'].forEach(setupColorInputs);

// åº”ç”¨å­—æ®µæ ·å¼
dom.applyFieldStyles.addEventListener('click', () => {
  const newStyles = {
    project: {
      color: dom.projectColorInput.value || dom.projectColorPicker.value,
      bg: dom.projectBgInput.value || dom.projectBgPicker.value,
      border: currentFieldStyles.project.border // Use the currently calculated border
    },
    context: {
      color: dom.contextColorInput.value || dom.contextColorPicker.value,
      bg: dom.contextBgInput.value || dom.contextBgPicker.value,
      border: currentFieldStyles.context.border
    },
    priority: {
      color: dom.priorityColorInput.value || dom.priorityColorPicker.value,
      bg: dom.priorityBgInput.value || dom.priorityBgPicker.value,
      border: currentFieldStyles.priority.border
    },
    date: {
      color: dom.dateColorInput.value || dom.dateColorPicker.value,
      bg: dom.dateBgInput.value || dom.dateBgPicker.value,
      border: currentFieldStyles.date.border
    },
    url: {
      color: dom.urlColorInput.value || dom.urlColorPicker.value,
      bg: dom.urlBgInput.value || dom.urlBgPicker.value,
      border: currentFieldStyles.url.border
    }
  };
  
  currentFieldStyles = newStyles;
  saveFieldStyles(currentFieldStyles);
  applyFieldStyles(currentFieldStyles);
  fieldStyleModal.classList.remove('open');
  showToast('å­—æ®µæ ·å¼å·²åº”ç”¨');
});

// é‡ç½®å­—æ®µæ ·å¼
dom.resetFieldStyles.addEventListener('click', () => {
  const defaultStyles = getDefaultFieldStyles();
  currentFieldStyles = defaultStyles;
  saveFieldStyles(currentFieldStyles);
  applyFieldStyles(currentFieldStyles);
  updateFieldStyleInputs();
  updateFieldStylePreviews();
  showToast('å­—æ®µæ ·å¼å·²é‡ç½®');
});

// å­—æ®µæ ·å¼é…ç½®çª—å£æ‹–åŠ¨åŠŸèƒ½
const fieldStyleModalDragHandle = dom.fieldStyleModalDragHandle;
(function makeFieldStyleModalDraggable(fieldStyleModal, fieldStyleModalDragHandle){
  let isDown=false, startX=0, startY=0, startLeft=0, startTop=0;
  fieldStyleModalDragHandle.addEventListener('mousedown', (e)=>{
    isDown=true;
    const rect = fieldStyleModal.getBoundingClientRect();
    startX = e.clientX; startY = e.clientY;
    startLeft = rect.left; startTop = rect.top;
    e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    fieldStyleModal.style.left = (startLeft + dx) + 'px';
    fieldStyleModal.style.top  = (startTop  + dy) + 'px';
    fieldStyleModal.style.transform = 'translate(0,0)';
  }, {passive: true});
  window.addEventListener('mouseup', ()=> isDown=false);
})(dom.fieldStyleModal, dom.fieldStyleModalDragHandle);

/* ========= äº‹ä»¶ ========= */
dom.applyTxt.addEventListener('click', ()=> {
  applyRawText(dom.raw.value);
});

const onSearch = debounce(() => {
  dom.clearSearch.style.display = dom.search.value.trim() ? 'block' : 'none';
  render();
}, 200);

dom.search.addEventListener('input', onSearch);
dom.search.addEventListener('focus', ()=> {
  if (!dom.search.value.trim()) dom.searchHints.classList.add('show');
});
dom.search.addEventListener('blur', ()=> {
  setTimeout(()=> dom.searchHints.classList.remove('show'), 150);
});

dom.clearSearch.addEventListener('click', ()=> {
  dom.search.value = '';
  dom.clearSearch.style.display = 'none';
  dom.searchHints.classList.remove('show');
  render();
});

dom.status.addEventListener('input', render);

dom.appTitle.addEventListener('click', ()=> {
  location.reload();
});

dom.settingsBtn.addEventListener('click', ()=> dom.drawer.classList.add('open'));
dom.closeDrawer.addEventListener('click', ()=> dom.drawer.classList.remove('open'));
dom.sort.addEventListener('input', render);
dom.groupBy.addEventListener('input', render);

dom.saveGistSettings.addEventListener('click', () => {
  localStorage.setItem(GIST_ID_KEY, dom.gistId.value.trim());
  localStorage.setItem(GIST_PAT_KEY, dom.githubPat.value.trim());
  showToast('Gist å‡­æ®å·²ä¿å­˜');
  dom.drawer.classList.remove('open');
});

dom.pullFromGistBtn.addEventListener('click', pullFromGist);
dom.pushToGistBtn.addEventListener('click', pushToGist);

function performExpiredCleanup() {
  const now = new Date();
  const today = new Date(now.toDateString());
  const expiredTasks = tasks.filter(t => {
    if (t.done) return false;
    const due = parseDateMaybe(t.kv['due']);
    const end = parseDateMaybe(t.kv['end']);
    return (due && due < today) || (end && end < now);
  });

  if (expiredTasks.length === 0) {
    showToast('æ²¡æœ‰å·²è¿‡æœŸçš„ä»»åŠ¡');
    return;
  }

  const expiredRecurring = expiredTasks.filter(t => t.kv['rec']);
  const expiredNormal = expiredTasks.filter(t => !t.kv['rec']);

  let newTasks = tasks.slice();
  let generatedCount = 0;

  for (const expiredTask of expiredRecurring) {
    let nextCandidate = completeAndMaybeRecur(JSON.parse(JSON.stringify(expiredTask)));
    let iterationCount = 0;
    const MAX_ITERATIONS = 365 * 5;
    while (nextCandidate && iterationCount < MAX_ITERATIONS) {
      const candDue = parseDateMaybe(nextCandidate.kv['due']);
      const candEnd = parseDateMaybe(nextCandidate.kv['end']);
      const isStillExpired = (candDue && candDue < today) || (candEnd && candEnd < now);
      if (!isStillExpired) break;
      nextCandidate = completeAndMaybeRecur(nextCandidate);
      iterationCount++;
    }
    if (nextCandidate) {
      const idx = newTasks.indexOf(expiredTask);
      if (idx !== -1) newTasks[idx] = nextCandidate; // Replace old with new
      generatedCount++;
    } else {
      newTasks = newTasks.filter(t => t !== expiredTask); // If no next, remove expired
    }
  }

  newTasks = newTasks.filter(t => !expiredNormal.includes(t)); // Remove normal expired tasks
  setTasks(newTasks);

  let toastMsg = `å·²æ¸…ç† ${expiredTasks.length} ä¸ªè¿‡æœŸä»»åŠ¡`;
  if (generatedCount > 0) {
    toastMsg += `ï¼Œç”Ÿæˆ ${generatedCount} ä¸ªæ–°å‘¨æœŸä»»åŠ¡`;
  }
  showToast(toastMsg);
}

dom.quickCleanupBtn.addEventListener('click', () => {
  const host = dom.list; 

  const now = new Date();
  const today = new Date(now.toDateString());
  const expiredTasks = tasks.filter(t => {
    if (t.done) return false;
    const due = parseDateMaybe(t.kv['due']);
    const end = parseDateMaybe(t.kv['end']);
    return (due && due < today) || (end && end < now);
  });

  if (expiredTasks.length === 0) {
    showToast('æ²¡æœ‰å·²è¿‡æœŸçš„ä»»åŠ¡');
    return;
  }

  const oldConfirm = host.querySelector('.confirm-bar');
  if (oldConfirm) oldConfirm.remove();

  const expiredRecurring = expiredTasks.filter(t => t.kv['rec']);
  const bar = document.createElement('div');
  bar.className = 'confirm-bar';
  bar.style.margin = '0 0 12px 0';
  let message = `æ¸…ç† ${expiredTasks.length} ä¸ªå·²è¿‡æœŸä»»åŠ¡ï¼Ÿ`;
  if (expiredRecurring.length > 0) {
    message += ` (åŒ…æ‹¬ ${expiredRecurring.length} ä¸ªå‘¨æœŸä»»åŠ¡ï¼Œå°†ç”Ÿæˆæ–°å‘¨æœŸ)`;
  }
  bar.innerHTML = `<span>${message}`;

  const yes = document.createElement('button');
  yes.className = 'btn destructive';
  yes.textContent = 'æ¸…ç†';
  const no = document.createElement('button');
  no.className = 'btn';
  no.textContent = 'å–æ¶ˆ';

  yes.onclick = () => {
    bar.remove();
    performExpiredCleanup();
  };
  no.onclick = () => bar.remove();

  bar.append(yes, no);
  host.prepend(bar);
});

dom.clearDoneBtn.addEventListener('click', ()=> {
  const host = dom.settingsConfirmHost;
  host.innerHTML = '';
  const bar = document.createElement('div'); bar.className='confirm-bar';
  bar.innerHTML = '<span>æ¸…ç†æ‰€æœ‰å·²å®Œæˆä»»åŠ¡ï¼Ÿ</span>';
  const yes = document.createElement('button'); yes.className='btn destructive'; yes.textContent='æ¸…ç†';
  const no = document.createElement('button'); no.className='btn'; no.textContent='å–æ¶ˆ';
  yes.onclick = ()=> { setTasks(tasks.filter(x=>!x.done)); bar.remove(); showToast('å·²æ¸…ç†'); };
  no.onclick  = ()=> bar.remove();
  bar.append(yes, no);
  host.append(bar);
});

dom.clearExpiredBtn.addEventListener('click', ()=> {
  const host = dom.settingsConfirmHost;
  host.innerHTML = '';
  
  const now = new Date();
  const today = new Date(now.toDateString());
  const expiredTasks = tasks.filter(t => {
    if (t.done) return false;
    const due = parseDateMaybe(t.kv['due']);
    const end = parseDateMaybe(t.kv['end']);
    return (due && due < today) || (end && end < now);
  });
  
  if (expiredTasks.length === 0) {
    showToast('æ²¡æœ‰å·²è¿‡æœŸçš„ä»»åŠ¡');
    return;
  }
  
  const expiredRecurring = expiredTasks.filter(t => t.kv['rec']);
  const expiredNormal = expiredTasks.filter(t => !t.kv['rec']);
  
  const bar = document.createElement('div'); bar.className='confirm-bar';
  let message = `æ¸…ç† ${expiredTasks.length} ä¸ªå·²è¿‡æœŸä»»åŠ¡ï¼Ÿ`;
  if (expiredRecurring.length > 0) {
    message += ` (åŒ…æ‹¬ ${expiredRecurring.length} ä¸ªå‘¨æœŸä»»åŠ¡ï¼Œå°†ç”Ÿæˆæ–°å‘¨æœŸ)`;
  }
  bar.innerHTML = `<span>${message}</span>`;
  
  const yes = document.createElement('button'); yes.className='btn destructive'; yes.textContent='æ¸…ç†';
  const no = document.createElement('button'); no.className='btn'; no.textContent='å–æ¶ˆ';
  yes.onclick = ()=> { 
    bar.remove();
    performExpiredCleanup();
  };
  no.onclick = ()=> bar.remove();
  bar.append(yes, no);
  host.append(bar);
});

dom.exportBtn.addEventListener('click', exportTxt);
dom.importInput.addEventListener('change', async (e)=> {
  const f = e.target.files[0]; if (!f) return;
  const text = await f.text();
  applyRawText(text);
  showToast('å·²å¯¼å…¥');
  e.target.value = ''; // Clear file input
});
dom.resetBtn.addEventListener('click', ()=> {
  const host = dom.settingsConfirmHost;
  host.innerHTML = '';
  const bar = document.createElement('div'); bar.className='confirm-bar';
  bar.innerHTML = '<span>ç¡®è®¤æ¸…ç©ºå…¨éƒ¨ä»»åŠ¡ä¸æ–‡æœ¬ï¼Ÿ</span>';
  const yes = document.createElement('button'); yes.className='btn destructive'; yes.textContent='æ¸…ç©º';
  const no = document.createElement('button'); no.className='btn'; no.textContent='å–æ¶ˆ';
  yes.onclick = ()=> { setTasks([], {updateRawEditor:true, shouldSave:true}); bar.remove(); showToast('å·²æ¸…ç©º'); };
  no.onclick  = ()=> bar.remove();
  bar.append(yes, no);
  host.append(bar);
});

const modal = dom.editorModal;
const dragHandle = dom.modalDragHandle;
dom.openEditorBtn.addEventListener('click', ()=> {
  dom.editorModal.classList.add('open'); // å…ˆæ‰“å¼€å¼¹çª—
  syncRawEditorWithValue();              // å†å¡«å……å†…å®¹
});
dom.closeEditor.addEventListener('click', ()=> dom.editorModal.classList.remove('open'));
(function makeDraggable(){
  let isDown=false, startX=0, startY=0, startLeft=0, startTop=0;
  dragHandle.addEventListener('mousedown', (e)=>{
    isDown=true;
    const rect = modal.getBoundingClientRect();
    startX = e.clientX; startY = e.clientY;
    startLeft = rect.left; startTop = rect.top;
    e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    modal.style.left = (startLeft + dx) + 'px';
    modal.style.top  = (startTop  + dy) + 'px';
    modal.style.transform = 'translate(0,0)';
  }, {passive: true});
  window.addEventListener('mouseup', ()=> isDown=false);
})();

dom.raw.addEventListener('keydown', (e)=> {
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s') { e.preventDefault(); applyRawText(e.target.value); }
});

setInterval(()=> {
  const now = new Date();
  for (const t of tasks) {
    if (!t) continue;
    if (t._descEl) {
      if (t.done) {
        const doneat = t.kv['doneat'] || (t.completedDate? fmtDate(parseDateMaybe(t.completedDate), true, true) : '');
        t._descEl.textContent = doneat ? `å®Œæˆäº ${doneat.replace('T', ' ')}` : 'å·²å®Œæˆ';
      } else {
        t._descEl.textContent = describeTaskTime(t, now);
      }
    }
  }
}, 1000);

if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js')
      .then(function(registration) {
        console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
        showToast('åº”ç”¨å·²æ”¯æŒç¦»çº¿ä½¿ç”¨ï¼');
      })
      .catch(function(error) {
        console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
      });
  });
} else if (location.protocol === 'file:') {
  console.log('PWAåŠŸèƒ½éœ€è¦åœ¨HTTP/HTTPSåè®®ä¸‹è¿è¡Œï¼Œå½“å‰ä¸ºfile://åè®®');
}

loadGistSettings();

if (tasks.length===0) {
  const seed = [
    '(A) 2025-09-20 Backup system +Ops @server rec:1d start:2025-09-20T05:00 end:2025-09-20T05:30 count:3',
    'Write report +Work @computer due:2025-09-30',
    'Buy milk @errands'
  ].join('\n');
  applyRawText(seed); // This calls setTasks, which saves and renders.
} else {
  render();
}

})();
</script>
</body>
</html>